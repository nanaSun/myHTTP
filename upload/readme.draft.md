# ç”¨KOAæ­å»ºä¸€ä¸ªFORMè¡¨å•ä¸Šä¼ çš„çŽ¯å¢ƒ

ä¸Šä¸Šä¸Šä¸€æœŸé“¾æŽ¥â€”â€”ä¹Ÿå°±æ˜¯æœ¬æ–‡çš„åŸºç¡€ï¼Œ[å‚è€ƒKOAï¼Œ5æ­¥æ‰‹å†™ä¸€æ¬¾ç²—ç³™çš„webæ¡†æž¶](https://juejin.im/post/5b7e8718e51d4538ca573445)

ä¸Šä¸Šä¸€æœŸé“¾æŽ¥â€”â€”æœ‰å…³Routerçš„å®žçŽ°æ€è·¯ï¼Œ[è¿™ä»½Koaçš„ç®€æ˜“Routeræ‰‹æ•²æŒ‡å—è¯·æ”¶ä¸‹](https://juejin.im/post/5b7fd1bc6fb9a019b421cc35)

ä¸Šä¸€æœŸé“¾æŽ¥â€”â€”æœ‰å…³æ¨¡æ¿å¼•æ“Žçš„å®žçŽ°æ€è·¯ï¼Œ[KOAçš„ç®€æ˜“æ¨¡æ¿å¼•æ“Žå®žçŽ°æ–¹å¼](https://juejin.im/post/5b865aeb6fb9a01a040717fb)

æœ¬æ–‡å‚è€ƒä»“åº“ï¼š[ç‚¹æˆ‘](https://github.com/nanaSun/myHTTP/tree/master/upload)

åšè¿™ä¸ªè¡¨å•ä¸Šä¼ çš„æ—¶å€™ï¼Œæˆ‘è¢«å°å°äº†ï¼ŒçœŸçš„æ˜¯å°å°äº†ï¼Œè¿™ä¸ªè¡¨å•ä¸Šä¼ çœ‹ä¼¼äººç•œæ— å®³ï¼Œå®žåˆ™æš—è—çŽ„æœºï¼Œè®©æˆ‘ä¸åä¸å¿«ã€‚

æˆ‘åœ¨ç ”ç©¶è¿™ä¸ªä¸Šä¼ çš„ä¸­é—´ä»¶çš„æ—¶å€™ï¼Œå¤§æ¦‚å°±å±žäºŽï¼Œè¿™ä¸ªå¾ˆç®€å•ï¼Œæºç éƒ½å°è£…å¥½äº†ï¼Œæ‹¿æ¥ç”¨å°±å¥½äº†ã€‚å¯æ˜¯æˆ‘å¤ªå¤©çœŸäº†ã€‚æºç ç»™ä½ çš„çœŸçš„æ˜¯â€œæºç â€ï¼Œæ— ä»»ä½•å¤„ç†çš„æ•°æ®ï¼Œç»å¯¹çš„å¤©ç„¶æ— æ±¡æŸ“ï¼å½“æ—¶æˆ‘å°±éœ‡æƒŠäº†ï¼Œæœ¬æ¥æƒ³30åˆ†é’Ÿè¿‡ä¸€éï¼Œå°±å¯ä»¥ç»“æŸäº†ã€‚ç»“æžœðŸ˜­â€¦â€¦ï¼Œå¤§å“¥ï¼Œæˆ‘é”™äº†ï¼Œæˆ‘ä¸€å®šå¥½å¥½ç ”ç©¶â€¦â€¦

åœ¨å¼€å§‹åŠ¨æ‰‹æ•²ä»£ç å‰ï¼Œè¿˜æœ‰å‡ ç‚¹çŸ¥è¯†éœ€è¦ç§‘æ™®ä¸‹ï¼š

* [å®¢æˆ·ç«¯ï¼ˆclientï¼‰åƒæœåŠ¡å™¨ï¼ˆserverï¼‰å‘é€ä¿¡æ¯ã€‚](https://juejin.im/post/5b7919345188254312414b9c#heading-5)ï¼šå¦‚æžœä¸è¿›è¡Œè¿™ä¸ªæ“ä½œï¼Œæˆ‘ä»¬æ— æ³•å¾—çŸ¥å‘ç”Ÿäº†ä»€ä¹ˆã€‚
* fsçš„å„ç±»æ“ä½œï¼ˆè¿™ä¸ªç­‰æˆ‘ç¨åŽè¡¥ä¸Šï¼Œå“ˆå“ˆå“ˆå“ˆï¼‰ï¼šè¿™ä¸ªæ“ä½œç”¨äºŽå°†ç”¨æˆ·ä¸Šä¼ çš„å†…å®¹ä¿å­˜åˆ°æœ¬åœ°ã€‚

## é‡ç‚¹â€œåŽŸæ–™â€ä»£ç 

èŽ·å–HEADERSä¿¡æ¯

```
Content-Length: 230
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfWSJqD9FgKeYfOTF
```

æ‹¼æŽ¥èŽ·å–çš„èµ„æºï¼Œå¹¶ç»„åˆã€‚

```
let buf=[]
ctx.req.on("data",(data)=>{
    buf.push(data)
});
ctx.req.on("end",(data)=>{
    string=Buffer.concat(buf).toString()
})
```

è¿‡æ»¤æ ¼å¼åŒ–èŽ·å–åˆ°çš„æ•°æ®ï¼Œç„¶åŽå°±è¦å¼€å§‹å¯æ€•çš„æ­£åˆ™æå–æœ‰æ•ˆå­—æ®µå’Œå†…å®¹ã€‚

```
------WebKitFormBoundaryfWSJqD9FgKeYfOTF
Content-Disposition: form-data; name="text"

111
------WebKitFormBoundaryfWSJqD9FgKeYfOTF
Content-Disposition: form-data; name="aaa"; filename="checked.png"
Content-Type: image/png

ï¿½PNG

------WebKitFormBoundaryfWSJqD9FgKeYfOTF--
```

å¥½äº†ï¼Œæˆ‘ä»¬å¼€å§‹ä¸€æ­¥æ­¥å®žçŽ°å§ï¼

## STEP1 åˆ›å»ºä¸€ä¸ªä¸­é—´ä»¶

è¿™ä¸ªä¸­é—´ä»¶ï¼Œæ”¾äºŽä»£ç æœ€ä¸Šæ–¹ï¼Œæ¯æ¬¡é¡µé¢è®¿é—®çš„æ—¶å€™ï¼Œè¿›è¡Œç›‘å¬ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰æ•°æ®ä¼ ç»™æœåŠ¡å™¨ï¼Œæœ‰çš„è¯ï¼Œå°±æŽ¥æ”¶ç•™ç»™åŽæ–¹ç¨‹åºä½¿ç”¨ã€‚ç„¶åŽå†ç»§ç»­è¿›è¡ŒåŽç»­ä¸­é—´ä»¶/ä»£ç çš„æ‰§è¡Œã€‚

```
function bodyparser(){
    return async (ctx,next)=>{
        await next();
    }
}
```

æœåŠ¡å™¨ç«¯æŽ¥å—æ•°æ®çš„æ–¹å¼ï¼Œå¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰,é€šè¿‡`data`äº‹ä»¶ç›‘å¬æ¯æ¬¡èŽ·å–åˆ°çš„æ•°æ®ï¼Œç„¶åŽå°†ç¼“å­˜`push`åˆ°æ•°ç»„ä¸­ã€‚ç­‰åˆ°å…¨éƒ¨æŽ¥æ”¶å®Œæ¯•ï¼Œè§¦å‘`end`äº‹ä»¶ï¼Œå°†ç¼“å­˜æ‹¼æŽ¥åˆ°ä¸€èµ·è½¬åŒ–æˆå­—ç¬¦ä¸²ã€‚

```
let buf = [];
let string="";  
ctx.req.on("data",(data)=>{
    buf.push(data)
});
ctx.req.on("end",(data)=>{
    string=Buffer.concat(buf).toString()
}
```



